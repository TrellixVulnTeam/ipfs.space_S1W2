<html>
    <head>
        <meta charset="UTF-8">
        <title>IPFS Hosting and Pinning Service</title>

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/css/bootstrap.min.css" integrity="sha384-Zug+QiDoJOrZ5t4lssLdxGhVrurbmBWopoEl+M6BdEfwnCJZtKxi1KgxUyJq13dy" crossorigin="anonymous">
        <link rel="stylesheet" href="css/app.css">

        <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js" integrity="sha256-8E6QUcFg1KTnpEU8TFGhpTGHw5fJqB9vCms3OhAYLqw=" crossorigin="anonymous"></script>
        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/js/bootstrap.min.js" integrity="sha384-a5N7Y/aK3qNeh15eJKGWxsqtnX/wWdSZSKp+81YjTmS15nvnvxKHuzaWwXHDli+4" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/ipfs/dist/index.min.js"></script>
        <script src="https://www.gstatic.com/firebasejs/4.9.0/firebase.js"></script>
        <script src="https://www.gstatic.com/firebasejs/4.9.0/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/4.9.0/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/4.9.0/firebase-database.js"></script>
        <script>
          // Initialize Firebase
          var config = {
            apiKey: "AIzaSyDyAmz2ahqbA4JN4xDydRij7ju3m6_QxhQ",
            authDomain: "ipfs-space.firebaseapp.com",
            databaseURL: "https://ipfs-space.firebaseio.com",
            projectId: "ipfs-space",
            storageBucket: "ipfs-space.appspot.com",
            messagingSenderId: "598908228635"
          };
          firebase.initializeApp(config);
        </script>
        <script src="js/app.js"></script>

        <script>
            $(document).ready(function() {
                const ipfs = new Ipfs();

                // Hack: There is a bug in EmbarkJS where the contract objects
                // are not ready on documentReady.
                __mainContext.__loadManagerInstance.execWhenReady(function() {
                    $('.refresh').click(refresh);
                    refresh();
                });

                var refresh = function() {
                    $('#files tbody').empty();

                    App.methods.getPins().call(function(err, pinAddresses) {
                        _.each(pinAddresses, function(pinAddress) {
                            var pin = EmbarkJS.Contract({address: pinAddress, abi: Pin._jsonInterface});
                            pin.methods.getMetadata().call(function(err, data) {
                                var fileHash = data[0];
                                var balance = web3.utils.fromWei(data[1], 'ether');

                                $('#files tbody').append('<tr>' +
                                    '<td class="align-middle">/ipfs/' + fileHash + '</td>' +
                                    '<td class="align-middle">' + balance + ' ETH</td>' +
                                    '<td class="align-middle">' +
                                        '<div class="input-group input-group-sm">' +
                                            '<button type="button" class="btn btn-sm btn-outline-primary mr-1">Add time</button>' +
                                            '<button type="button" class="btn btn-sm btn-outline-danger">Unpin</button>' +
                                        '</div>' +
                                    '</td>' +
                                '</tr>');
                            });
                        });
                    });
                };

                $('#confirm-amount').on('keyup', function() {
                    var usd = $('#confirm-amount').val();
                    var eth = usd * USD_TO_ETH;
                    var fileSize = $('#confirm-file-size').val();
                    var days = Math.round(usd / fileSize * PRICE_PER_GB_DAY);

                    $('#approx-eth').html(eth);
                    $('#approx-expire').html(days);
                });

                $('#pay').click(function() {
                    var fileHash = $('#file-hash').val();
                    var usd = $('#confirm-amount').val();
                    var eth = usd * USD_TO_ETH;
                    var wei = web3.utils.toWei(eth, 'ether');

                    App.methods.addPin(fileHash).send({
                        from: WEB3_ACTIVE_ACCOUNT,
                        value: wei,
                        gas: 900000
                    }).then(function(){
                        console.log("Added pin successfully");
                    });
                });

                $('#pin').click(function() {
                    var fileHash = $('#file-hash').val();
                    ipfs.object.stat(fileHash, function(err, stat) {
                        if (!err) {
                            console.log(stat);

                            var fileSize = stat.CumulativeSize/1000000000;
                            $('#confirm-file-hash').val(fileHash);
                            $('#confirm-file-size').val(fileSize);
                            $('#confirm-price').val();
                            $('#confirm-modal').modal('show');
                        } else {
                            console.log(err);
                        }
                    });
                });
            });

        </script>

    </head>
    <body>
        <div class="container">
            <ul class="nav justify-content-end">
                <li class="nav-item">
                    <a class="nav-link active" href="signup.html">Sign up</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Manage files</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="deposit.html">Deposit</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">API</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Help</a>
                </li>
            </ul>
            <h1 class="display-5">ðŸš€ ipfs.space</h1>
            <p class="lead">Pinning service for IPFS. Hosting for the distributed web.</p>
        </div>

        <div class="container mt-5">
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text" id="basic-addon1">/ipfs/</span>
                </div>
                <input id="file-hash" type="text" class="form-control" placeholder="hash" aria-label="IPFS hash" aria-describedby="basic-addon2">
                <div class="input-group-append">
                    <button id="pin" class="btn btn-outline-primary" type="button">Pin</button>
                </div>
            </div>
        </div>

        <div class="container mt-5">
            <table id="files" class="table table-hover table-striped table-bordered">
                <thead>
                    <tr>
                        <th scope="col">Hash</th>
                        <th scope="col">Balance</th>
                        <th scope="col">Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>

            <button class="btn btn-secondary refresh" type="button">Refresh âŸ³</button>
        </div>

        <div id="confirm-modal" class="modal" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Pin file</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form>
                            <div class="form-group">
                                <label for="confirm-file-hash">IPFS hash</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" id="basic-addon1">/ipfs/</span>
                                    </div>
                                    <input id="confirm-file-hash" type="text" class="form-control" placeholder="hash" aria-label="IPFS hash" aria-describedby="basic-addon2" readonly>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="confirm-file-size">File size</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="confirm-file-size" placeholder="N/A" readonly>
                                    <div class="input-group-append">
                                        <div class="input-group-text">GB</div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="confirm-amount">Amount</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <div class="input-group-text">$</div>
                                    </div>
                                    <input type="text" class="form-control" id="confirm-amount" placeholder="0.00">
                                </div>
                                <small id="confirm-eth-help" class="form-text text-muted">~<span id="approx-eth">0</span> ETH</small>
                                <small id="confirm-expire-help" class="form-text text-muted">File will be pinned for ~<span id="approx-expire">0</span> days.</small>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button id="pay" type="button" class="btn btn-primary">Pay</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
